C51 COMPILER V9.00   BUTTON                                                                05/30/2016 16:15:41 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE BUTTON
OBJECT MODULE PLACED IN Button.OBJ
COMPILER INVOKED BY: E:\software\DevelopmentSoftware\InstallSrc\KeilC51\C51\BIN\C51.EXE Button.c COMPACT BROWSE DEBUG OB
                    -JECTEXTEND

line level    source

   1          #include "stc15.h"
   2          #include "Delay.h"
   3          #include "LCD12864.H"
   4          #include "main.h"
   5          #include "Timer.h"
   6          #include "Button.h"
   7          #include "FLASH.h"
   8          #include "DS1302.h"
   9          
  10          unsigned char code SetString[] = {"设置："};
  11          
  12          void INT0_Init()
  13          {       
  14   1              IT0=1;                                          // 设置为下降沿触发
  15   1              EX0=1;                                          // 开外部中断0                    P3.2 INT0
  16   1      }
  17          void EXT0(void) interrupt 0
  18          {
  19   1          Delay20ms();
  20   1              Delay20ms();
  21   1              if(P32==0)                                                      // 仍然是按下状态
  22   1              {
  23   2                      if(ISSETTING==0)
  24   2                      { 
  25   3                          P20 = !P20;
  26   3                              ISSETTING=1;
  27   3                              DisableTimer0();                        // 关闭超声波 温湿度的定时器中断
  28   3                              DisableTimer3();                        // 关闭蜂鸣器的定时器中断
  29   3                      }
  30   2                      else
  31   2                      {
  32   3                          //P26 = !P26;
  33   3                          ISSETTING=0;
  34   3                              EXITSETTING=1; 
  35   3                              EnableTimer0();                         // 关闭超声波 温湿度的定时器中断
  36   3                              EnableTimer3();                         // 关闭蜂鸣器的定时器中断                       
  37   3                      }
  38   2              }
  39   1              else                                                            // 抖动
  40   1              {
  41   2                      ; 
  42   2              }       
  43   1      }
  44          
  45          /*调整时间部分,注意:不会自动调整星期的！因为用不到它,时间不会进位、不会退位
  46            不判断闰年...自行调整,别调过了*/
  47          void AddYear(unsigned char *year, signed char mode)
  48          {
  49   1              if(mode==1)
  50   1              {
  51   2                      if(year<30)
  52   2                              (*year)++;
  53   2                      else
  54   2                              (*year)=0;
C51 COMPILER V9.00   BUTTON                                                                05/30/2016 16:15:41 PAGE 2   

  55   2              }
  56   1              else
  57   1              {
  58   2                      if(year>0)
  59   2                              (*year)--;
  60   2                      else
  61   2                              (*year)=30;
  62   2              }
  63   1      }
  64          
  65          void AddMonth(unsigned char *month, signed char mode)
  66          {
  67   1              if(mode==1)
  68   1              {
  69   2                      if(month<12)
  70   2                              (*month)++;
  71   2                      else
  72   2                              (*month)=0;
  73   2              }
  74   1              else
  75   1              {
  76   2                      if(month>0)
  77   2                              (*month)--;
  78   2                      else
  79   2                              (*month)=12;
  80   2              }
  81   1      }
  82          
  83          void AddDay(unsigned char *day, signed char mode)
  84          {
  85   1              if(mode==1)
  86   1              {
  87   2                      if(day<31)
  88   2                              (*day)++;
  89   2                      else
  90   2                              (*day)=0;
  91   2              }
  92   1              else
  93   1              {
  94   2                      if(day>0)
  95   2                              (*day)--;
  96   2                      else
  97   2                              (*day)=31;
  98   2              }
  99   1      }
 100          
 101          void AddHour(unsigned char *hour, signed char mode)
 102          {
 103   1              if(mode==1)
 104   1              {
 105   2                      if(hour<24)
 106   2                              (*hour)++;
 107   2                      else
 108   2                              (*hour)=0;
 109   2              }
 110   1              else
 111   1              {
 112   2                      if(hour>0)
 113   2                              (*hour)--;
 114   2                      else
 115   2                              (*hour)=24;
 116   2              }
C51 COMPILER V9.00   BUTTON                                                                05/30/2016 16:15:41 PAGE 3   

 117   1      }
 118          
 119          void AddMinute(unsigned char *minute, signed char mode)
 120          {
 121   1              if(mode==1)
 122   1              {
 123   2                      if(minute<59)
 124   2                              (*minute)++;
 125   2                      else
 126   2                              (*minute)=0;
 127   2              }
 128   1              else
 129   1              {
 130   2                      if(minute>0)
 131   2                              (*minute)--;
 132   2                      else
 133   2                              (*minute)=59;
 134   2              }
 135   1      }
 136          
 137          void AddSecond(unsigned char *second, signed char mode)
 138          {
 139   1              if(mode==1)
 140   1              {
 141   2                      if(second<59)
 142   2                              (*second)++;
 143   2                      else
 144   2                              (*second)=0;
 145   2              }
 146   1              else
 147   1              {
 148   2                      if(second>0)
 149   2                              (*second)--;
 150   2                      else
 151   2                              (*second)=59;
 152   2              }
 153   1      }
 154          
 155          /*
 156           * 进入设置模式
 157           */
 158          void EnterSetting()
 159          {
 160   1          unsigned char VeloCitySettingFull1[] = {"速度上限："};
 161   1              unsigned char VeloCitySettingFull2[] = {"6 . 6 6 km/h"};
 162   1              unsigned char TimeSettingFull1[] = {"00年00月00日"};
 163   1              unsigned char TimeSettingFull2[] = {"00时00分00秒"};
 164   1              unsigned int TempVelocity;                                                                      //临时变量
 165   1              unsigned char TempTime[6] = {0,0,0,0,0,0};      
 166   1              unsigned char VelocityValue1 = 0;                                                                       //个位
 167   1              unsigned char VelocityValue2 = 0;                                                                       //十分之一位
 168   1              unsigned char VelocityValue3 = 0;                                                                       //百分之一位
 169   1          unsigned char Loc = 1;
 170   1              //unsigned char VelocityUp[] = {"速度上限：   m/s"};
 171   1              //LCD12864ClearScreen();
 172   1              //unsigned char Velocity1 = (unsigned char)(0 + 48);
 173   1              //unsigned char Velocity2 = (unsigned char)(0 + 48);
 174   1              //unsigned char VeloCitySetting1[] = {"速度上限：0."};
 175   1              //unsigned char VeloCitySetting2[] = {"速度上限：0.0m"};
 176   1              
 177   1          LCD12864SettingInit();
 178   1              //Display_String(1,SetString);
C51 COMPILER V9.00   BUTTON                                                                05/30/2016 16:15:41 PAGE 4   

 179   1              //Display_String(2,VelocityUp);
 180   1              Display_String(1,VeloCitySettingFull1);
 181   1              Display_String(2,VeloCitySettingFull2);
 182   1      
 183   1          TempVelocity = GetVelocityThreshold();
 184   1              DS1302_readoutTime(TempTime);
 185   1              //SendData(VelocityValue1);
 186   1              //SendData(VelocityValue1);
 187   1              //SendData(VelocityValue1);
 188   1              VelocityValue1 = TempVelocity%10000/1000;
 189   1              VelocityValue2 = TempVelocity%1000/100;
 190   1              VelocityValue3 = TempVelocity%100/10;  
 191   1              
 192   1              //LCD12864DisplayChar(2,2,'.');
 193   1              LCD12864DisplayChar(2,3,VelocityValue2 + 48);
 194   1              LCD12864DisplayChar(2,4,VelocityValue3 + 48);
 195   1              LCD12864DisplayChar(2,1,VelocityValue1 + 48);
 196   1               
 197   1              do                                                                              //矩阵键盘按键扫描
 198   1              {
 199   2                  KeyOut1 = 0;
 200   2                      KeyOut2 = 1;
 201   2                      Delay20ms();
 202   2                      if(KeyIn1 == 0)                                                                                         //调节左右
 203   2                      {       
 204   3                      Delay20ms();
 205   3                              Delay20ms();
 206   3                              if(KeyIn1 == 1) continue;
 207   3                              //P20 = !P20;
 208   3                              if(Loc == 1)                                               
 209   3                              {
 210   4                                      Loc = 2;
 211   4                                      LCD12864DisplayChar(2,3,VelocityValue2 + 48);
 212   4                              }
 213   3                              else if(Loc == 2)
 214   3                              {
 215   4                                      Loc = 3;
 216   4                                      LCD12864DisplayChar(2,4,VelocityValue3 + 48);                           
 217   4                              }
 218   3                              else if(Loc == 3)
 219   3                              {
 220   4                                      Loc = 4;
 221   4                                      LCD12864DisplayTwoChar(3,1,TempTime[0]/10 + 48,TempTime[0]%10 + 48);
 222   4                                      //年
 223   4                              }
 224   3                              else if(Loc == 4)
 225   3                              {
 226   4                                      Loc = 5;
 227   4                                      LCD12864DisplayTwoChar(3,3,TempTime[1]/10 + 48,TempTime[1]%10 + 48);
 228   4                                      //月
 229   4                              }
 230   3                              else if(Loc == 5)
 231   3                              {
 232   4                                      Loc = 6;
 233   4                                      LCD12864DisplayTwoChar(3,5,TempTime[2]/10 + 48,TempTime[2]%10 + 48);
 234   4                                      //日
 235   4                              }
 236   3                              else if(Loc == 6)
 237   3                              {
 238   4                                      Loc = 7;
 239   4                                      LCD12864DisplayTwoChar(4,1,TempTime[3]/10 + 48,TempTime[3]%10 + 48);
 240   4                                      //时
C51 COMPILER V9.00   BUTTON                                                                05/30/2016 16:15:41 PAGE 5   

 241   4                              }
 242   3                              else if(Loc == 7)
 243   3                              {
 244   4                                      Loc = 8;
 245   4                                      LCD12864DisplayTwoChar(4,3,TempTime[4]/10 + 48,TempTime[4]%10 + 48);
 246   4                                      //分
 247   4                              }
 248   3                              else if(Loc == 8)
 249   3                              {
 250   4                                      Loc = 9;
 251   4                                      LCD12864DisplayTwoChar(4,5,TempTime[5]/10 + 48,TempTime[5]%10 + 48);
 252   4                                      //秒
 253   4                              }
 254   3                              else
 255   3                              {
 256   4                                      Loc = 1;
 257   4                                      LCD12864DisplayChar(2,1,VelocityValue1 + 48);
 258   4                              }
 259   3                              while(KeyIn1==0);
 260   3                      }
 261   2      
 262   2                      if(KeyIn2 == 0)                                                                                         //调节左右
 263   2                      {       
 264   3                      Delay20ms();
 265   3                              Delay20ms();
 266   3                              if(KeyIn1 == 1) continue;
 267   3                              //P20 = !P20;
 268   3                              if(Loc == 3)                                               
 269   3                              {
 270   4                                      Loc = 2;
 271   4                                      LCD12864DisplayChar(2,3,VelocityValue2 + 48);
 272   4                              }
 273   3                              else if(Loc == 4)
 274   3                              {
 275   4                                      Loc = 3;
 276   4                                      LCD12864DisplayChar(2,4,VelocityValue3 + 48);                           
 277   4                              }
 278   3                              else if(Loc == 5)
 279   3                              {
 280   4                                      Loc = 4;
 281   4                                      LCD12864DisplayTwoChar(3,1,TempTime[0]/10 + 48,TempTime[0]%10 + 48);
 282   4                                      //年
 283   4                              }
 284   3                              else if(Loc == 6)
 285   3                              {
 286   4                                      Loc = 5;
 287   4                                      LCD12864DisplayTwoChar(3,3,TempTime[1]/10 + 48,TempTime[1]%10 + 48);
 288   4                                      //月
 289   4                              }
 290   3                              else if(Loc == 7)
 291   3                              {
 292   4                                      Loc = 6;
 293   4                                      LCD12864DisplayTwoChar(3,5,TempTime[2]/10 + 48,TempTime[2]%10 + 48);
 294   4                                      //日
 295   4                              }
 296   3                              else if(Loc == 8)
 297   3                              {
 298   4                                      Loc = 7;
 299   4                                      LCD12864DisplayTwoChar(4,1,TempTime[3]/10 + 48,TempTime[3]%10 + 48);
 300   4                                      //时
 301   4                              }
 302   3                              else if(Loc == 9)
C51 COMPILER V9.00   BUTTON                                                                05/30/2016 16:15:41 PAGE 6   

 303   3                              {
 304   4                                      Loc = 8;
 305   4                                      LCD12864DisplayTwoChar(4,3,TempTime[4]/10 + 48,TempTime[4]%10 + 48);
 306   4                                      //分
 307   4                              }
 308   3                              else if(Loc == 1)
 309   3                              {
 310   4                                      Loc = 9;
 311   4                                      LCD12864DisplayTwoChar(4,5,TempTime[5]/10 + 48,TempTime[5]%10 + 48);
 312   4                                      //秒
 313   4                              }
 314   3                              else
 315   3                              {
 316   4                                      Loc = 1;
 317   4                                      LCD12864DisplayChar(2,1,VelocityValue1 + 48);
 318   4                              }
 319   3                              while(KeyIn2==0);
 320   3                      }
 321   2                                                                                                                                              //调节值
 322   2                  KeyOut1 = 1;
 323   2                      KeyOut2 = 0;
 324   2                      Delay20ms();
 325   2                      if(KeyIn1 == 0)
 326   2                      {
 327   3                      Delay20ms();
 328   3                              Delay20ms();
 329   3                              if(KeyIn1 == 1) continue;
 330   3                              if(Loc == 1)                                               
 331   3                              {
 332   4                              if(VelocityValue1==0)
 333   4                                      {       
 334   5                                          VelocityValue1 = 9;
 335   5                                      LCD12864DisplayChar(2,1,VelocityValue1 + 48);
 336   5                                              }
 337   4                                      else
 338   4                                      {
 339   5                                              LCD12864DisplayChar(2,1,--VelocityValue1 + 48);
 340   5                                      }
 341   4                              }
 342   3                              else if(Loc == 2)
 343   3                              {
 344   4                                  if(VelocityValue2==0)
 345   4                                      {       
 346   5                                          VelocityValue2 = 9;
 347   5                                      LCD12864DisplayChar(2,3,VelocityValue2 + 48);
 348   5                                      }
 349   4                                      else
 350   4                                      {
 351   5                                              LCD12864DisplayChar(2,3,--VelocityValue2 + 48);
 352   5                                      }                               
 353   4                              }
 354   3                              else if(Loc == 3)
 355   3                              {
 356   4                                  if(VelocityValue3==0)
 357   4                                      {       
 358   5                                          VelocityValue3 = 9;
 359   5                                      LCD12864DisplayChar(2,4,VelocityValue3 + 48);
 360   5                                      }
 361   4                                      else
 362   4                                      {
 363   5                                              LCD12864DisplayChar(2,4,--VelocityValue3 + 48);
 364   5                                      }                                                                                  
C51 COMPILER V9.00   BUTTON                                                                05/30/2016 16:15:41 PAGE 7   

 365   4                              }
 366   3                              else if(Loc == 4)
 367   3                              {
 368   4                                  //年份加一
 369   4                                      AddYear(&TempTime[0],1);
 370   4                                      LCD12864DisplayTwoChar(3,1,TempTime[0]/10 + 48,TempTime[0]%10 + 48);
 371   4                              }
 372   3                              else if(Loc == 5)
 373   3                              {
 374   4                                  //月份加一
 375   4                                      AddMonth(&TempTime[1],1);
 376   4                                      LCD12864DisplayTwoChar(3,3,TempTime[1]/10 + 48,TempTime[1]%10 + 48);
 377   4                              }
 378   3                              else if(Loc == 6)
 379   3                              {
 380   4                                  //日期加一
 381   4                                      AddDay(&TempTime[2],1);
 382   4                                      LCD12864DisplayTwoChar(3,5,TempTime[2]/10 + 48,TempTime[2]%10 + 48);
 383   4                              }
 384   3                              
 385   3                              else if(Loc == 7)
 386   3                              {
 387   4                                  //小时加一
 388   4                                      AddHour(&TempTime[3],1);
 389   4                                      LCD12864DisplayTwoChar(4,1,TempTime[3]/10 + 48,TempTime[3]%10 + 48);
 390   4                              }
 391   3                              else if(Loc == 8)
 392   3                              {
 393   4                                  //分钟加一
 394   4                                      AddMinute(&TempTime[4],1);
 395   4                                      LCD12864DisplayTwoChar(4,3,TempTime[4]/10 + 48,TempTime[4]%10 + 48);
 396   4                              }
 397   3                              
 398   3                              else
 399   3                              {
 400   4                                  //秒加一
 401   4                                      AddSecond(&TempTime[5],1);
 402   4                                      LCD12864DisplayTwoChar(4,5,TempTime[5]/10 + 48,TempTime[5]%10 + 48);
 403   4                              }
 404   3                              while(KeyIn1==0);
 405   3                      }
 406   2      
 407   2                      if(KeyIn2 == 0)
 408   2                      {
 409   3                      Delay20ms();
 410   3                              Delay20ms();
 411   3                              if(KeyIn2 == 1) continue;
 412   3                              if(Loc == 1)                                               
 413   3                              {
 414   4                              if(VelocityValue1==9)
 415   4                                      {       
 416   5                                          VelocityValue1 = 0;
 417   5                                      LCD12864DisplayChar(2,1,VelocityValue1 + 48);
 418   5                                      }
 419   4                                      else
 420   4                                      {
 421   5                                              LCD12864DisplayChar(2,1,++VelocityValue1 + 48);
 422   5                                      }
 423   4                              }
 424   3                              else if(Loc == 2)
 425   3                              {
 426   4                                  if(VelocityValue2==9)
C51 COMPILER V9.00   BUTTON                                                                05/30/2016 16:15:41 PAGE 8   

 427   4                                      {       
 428   5                                          VelocityValue2 = 0;
 429   5                                      LCD12864DisplayChar(2,3,VelocityValue2 + 48);
 430   5                                      }
 431   4                                      else
 432   4                                      {
 433   5                                              LCD12864DisplayChar(2,3,++VelocityValue2 + 48);
 434   5                                      }                               
 435   4                              }
 436   3                              else if(Loc == 3)
 437   3                              {
 438   4                                  if(VelocityValue3==9)
 439   4                                      {       
 440   5                                          VelocityValue3 = 0;
 441   5                                      LCD12864DisplayChar(2,4,VelocityValue3 + 48);               
 442   5                                      }
 443   4                                      else
 444   4                                      {
 445   5                                              LCD12864DisplayChar(2,4,++VelocityValue3 + 48);
 446   5                                      }                                                                                  
 447   4                              }
 448   3                              else if(Loc == 4)
 449   3                              {
 450   4                                  //年份减一
 451   4                                      AddYear(&TempTime[0],-1);
 452   4                                      LCD12864DisplayTwoChar(3,1,TempTime[0]/10 + 48,TempTime[0]%10 + 48);
 453   4                              }
 454   3                              else if(Loc == 5)
 455   3                              {
 456   4                                  //月份减一
 457   4                                      AddMonth(&TempTime[1],-1);
 458   4                                      LCD12864DisplayTwoChar(3,3,TempTime[1]/10 + 48,TempTime[1]%10 + 48);
 459   4                              }
 460   3                              else if(Loc == 6)
 461   3                              {
 462   4                                  //日期减一
 463   4                                      AddDay(&TempTime[2],-1);
 464   4                                      LCD12864DisplayTwoChar(3,5,TempTime[2]/10 + 48,TempTime[2]%10 + 48);
 465   4                              }
 466   3                              
 467   3                              else if(Loc == 7)
 468   3                              {
 469   4                                  //小时减一
 470   4                                      AddHour(&TempTime[3],-1);
 471   4                                      LCD12864DisplayTwoChar(4,1,TempTime[3]/10 + 48,TempTime[3]%10 + 48);
 472   4                              }
 473   3                              else if(Loc == 8)
 474   3                              {
 475   4                                  //分钟减一
 476   4                                      AddMinute(&TempTime[4],-1);
 477   4                                      LCD12864DisplayTwoChar(4,3,TempTime[4]/10 + 48,TempTime[4]%10 + 48);
 478   4                              }
 479   3                              
 480   3                              else
 481   3                              {
 482   4                                  //秒减一
 483   4                                      AddSecond(&TempTime[5],-1);
 484   4                                      LCD12864DisplayTwoChar(4,5,TempTime[5]/10 + 48,TempTime[5]%10 + 48);
 485   4                              }
 486   3                              while(KeyIn2==0);
 487   3                      }                       
 488   2              }       
C51 COMPILER V9.00   BUTTON                                                                05/30/2016 16:15:41 PAGE 9   

 489   1              while(EXITSETTING == 0);                                                //当没有退出循环时在里面
 490   1              
 491   1              TempVelocity = 1000*VelocityValue1 + 100*VelocityValue2 + 10*VelocityValue3;    //计算速度阈值
 492   1              SetVelocityThreshold(TempVelocity,0);           //保存速度阈值
 493   1              LCD12864SettingExit();
 494   1              EXITSETTING = 0;
 495   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2044    ----
   CONSTANT SIZE    =     63    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----      62
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
