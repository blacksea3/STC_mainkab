C51 COMPILER V9.00   UART                                                                  05/23/2016 20:22:30 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN UART.OBJ
COMPILER INVOKED BY: E:\software\DevelopmentSoftware\InstallSrc\KeilC51\C51\BIN\C51.EXE UART.c COMPACT BROWSE DEBUG OBJE
                    -CTEXTEND

line level    source

   1          /*UART.c
   2          使用STC官方文档代码*/
   3          
   4          #include "reg51.h"
   5          #include "intrins.h"
   6          
   7          typedef unsigned char BYTE;
   8          typedef unsigned int WORD;
   9          
  10          #define FOSC 11059200L                       //系统频率
  11          #define BAUD 9600                          //串口波特率
  12          
  13          #define NONE_PARITY 0                        //无校验
  14          #define ODD_PARITY 1                         //奇校验
  15          #define EVEN_PARITY 2                        //偶校验
  16          #define MARK_PARITY 3                        //标记校验
  17          #define SPACE_PARITY 4                       //空白校验
  18          
  19          #define PARITYBIT EVEN_PARITY                //定义校验位
  20          
  21          sfr AUXR = 0x8e;                             //辅助寄存器
  22          sfr T2H = 0xd6;                            //定时器2高8位
  23          sfr T2L = 0xd7;                            //定时器2低8位
  24          
  25          sbit P22 = P2^2;
  26          
  27          bit busy;
  28          
  29          void SendData(BYTE dat);
  30          void SendString(char *s);
  31          void UARTInit();
  32          
  33          void UARTInit()
  34          {
  35   1      #if(PARITYBIT == NONE_PARITY)
                      SCON = 0x50;                                    //8位可变波特率
              #elif(PARITYBIT == ODD_PARITY)||(PARITYBIT == EVEN_PARITY)||(PARITYBIT == MARK_PARITY)
  38   1              SCON = 0xda;                                    //9位可变波特率,校验位初始为1
  39   1      #elif(PARITYBIT == SPACE_PARITY)        
                      SCON = 0xd2;                                    //9位可变波特率,校验位初始为0
              #endif
  42   1              
  43   1          T2L = (65536-(FOSC/4/BAUD));                //设置波特率重装值
  44   1              T2H = (65536-(FOSC/4/BAUD))>>8;
  45   1              AUXR |= 0x14;                                   //T2 1T模式,启动定时器2
  46   1              AUXR |= 0x01;                                   //定时器2为串口1的波特率发生器
  47   1              ES = 1;                                         //使能串口1中断
  48   1              PS = 1;                                 //UART中断调整为高优先级
  49   1              //EA = 1;                                       //使能总中断
  50   1      }
  51          
  52          /*-------------------------
  53          UART 中断服务程序
  54          -------------------------*/
C51 COMPILER V9.00   UART                                                                  05/23/2016 20:22:30 PAGE 2   

  55          void Uart() interrupt 4
  56          {
  57   1              if(RI)
  58   1              {
  59   2                      RI = 0;                     //清除RI位
  60   2                      P0 = SBUF;                  //P0显示串口数据
  61   2                      P22 = RB8;                  //P2.2显示检验位
  62   2              }
  63   1              if(TI)
  64   1              {
  65   2                      TI = 0;                     //清除TI位
  66   2                      busy = 0;                   //清忙标志
  67   2              }
  68   1      }
  69          
  70          /*--------------------------
  71          UART中断服务程序
  72          --------------------------*/
  73          void SendData(BYTE dat)
  74          {
  75   1              while(busy);                     //等待前面的数据发送完成
  76   1              ACC = dat;                       //获取校验位P(PSW.0)
  77   1              if(P)
  78   1              {
  79   2              #if(PARITYBIT == ODD_PARITY)
                              TB8 = 0;                     //设置校验位为0
                      #elif(PARITYBIT == EVEN_PARITY)
  82   2                      TB8 = 1;                     //设置校验位为1
  83   2              #endif
  84   2              }
  85   1              else
  86   1              {
  87   2              #if(PARITYBIT == ODD_PARITY)
                              TB8 = 1;                     //设置校验位为0
                      #elif(PARITYBIT == EVEN_PARITY)
  90   2                      TB8 = 0;                     //设置校验位为1
  91   2              #endif
  92   2              }
  93   1              busy = 1;
  94   1              SBUF = ACC;                      //写数据到UART数据寄存器
  95   1      }
  96          
  97          /*--------------------------
  98          发送字符串
  99          --------------------------*/
 100          void SendString(char *s)
 101          {
 102   1              while(*s)                        //检测字符串结束标志
 103   1              {
 104   2                      SendData(*s++);              //发送当前字符
 105   2              }
 106   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    114    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----       3
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
C51 COMPILER V9.00   UART                                                                  05/23/2016 20:22:30 PAGE 3   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
