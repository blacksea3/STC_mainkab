C51 COMPILER V9.00   UART                                                                  06/03/2016 18:24:02 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE UART
OBJECT MODULE PLACED IN UART.OBJ
COMPILER INVOKED BY: E:\software\DevelopmentSoftware\InstallSrc\KeilC51\C51\BIN\C51.EXE UART.c LARGE BROWSE DEBUG OBJECT
                    -EXTEND

line level    source

   1          /*UART.c
   2          使用STC官方文档代码*/
   3          
   4          #include "reg51.h"
   5          #include "intrins.h"
   6          #include "main.h"
   7          #include "Timer.h"
   8          
   9          typedef unsigned char BYTE;
  10          typedef unsigned int WORD;
  11          
  12          #define FOSC 11059200L                      //系统频率
  13          #define BAUD 115200                         //串口波特率
  14          
  15          #define NONE_PARITY 0                       //无校验
  16          #define ODD_PARITY 1                        //奇校验
  17          #define EVEN_PARITY 2                       //偶校验
  18          #define MARK_PARITY 3                       //标记校验
  19          #define SPACE_PARITY 4                      //空白校验
  20          
  21          #define PARITYBIT NONE_PARITY               //定义校验位
  22          
  23          #define PARITYBIT2 NONE_PARITY              //定义校验位
  24          
  25          sfr AUXR = 0x8e;                            //辅助寄存器
  26          sfr T2H = 0xd6;                                 //定时器2高8位
  27          sfr T2L = 0xd7;                                 //定时器2低8位
  28          sbit P22 = P2^2;
  29          bit busy,busy2;
  30          
  31          sfr S2CON = 0x9a;                                                       //UART2控制寄存器
  32          sfr S2BUF = 0x9b;                                                       //UART2数据寄存器
  33          sfr IE2 = 0xaf;                                                         //中断控制寄存器2
  34          
  35          sfr IP2 = 0xB5;                                                         //xxxx,xx00 中断优先级寄存器2
  36          
  37          sbit P15        =   P1^5;
  38          
  39          #define S2RI 0x01                                                       //S2CON.0
  40          #define S2TI 0x02                                                       //S2CON.1
  41          #define S2RB8 0x04                                                      //S2CON.2
  42          #define S2TB8 0x08                                                      //S2CON.3
  43          
  44          
  45          void SendData(BYTE dat);
  46          void SendString(char *s);
  47          void UARTInit();
  48          
  49          //unsigned char UART2Temp[256];
  50          //unsigned int UART2Loc = 0;
  51          //unsigned char UART1Temp[256];
  52          //unsigned int UART1Loc = 0;
  53          unsigned char UART1Temp;
  54          unsigned char UART2Temp;
C51 COMPILER V9.00   UART                                                                  06/03/2016 18:24:02 PAGE 2   

  55          
  56          void UARTInit()
  57          {
  58   1      #if(PARITYBIT == NONE_PARITY)
  59   1              SCON = 0x50;                                    //8位可变波特率
  60   1      #elif(PARITYBIT == ODD_PARITY)||(PARITYBIT == EVEN_PARITY)||(PARITYBIT == MARK_PARITY)
                      SCON = 0xda;                                    //9位可变波特率,校验位初始为1
              #elif(PARITYBIT == SPACE_PARITY)        
                      SCON = 0xd2;                                    //9位可变波特率,校验位初始为0
              #endif
  65   1              
  66   1          T2L = (65536-(FOSC/4/BAUD));                //设置波特率重装值
  67   1              T2H = (65536-(FOSC/4/BAUD))>>8;
  68   1              //TL1 = (65536-(FOSC/4/BAUD));
  69   1              //TH1 = (65536-(FOSC/4/BAUD))>>8;
  70   1              TMOD = 0x00;
  71   1              AUXR |= 0x14;                                   //T2 1T模式,启动定时器2
  72   1              AUXR |= 0x01;                                   //定时器2为串口1的波特率发生器
  73   1      
  74   1              ES = 1;                                         //使能串口1中断
  75   1              PS = 1;                                 //UART中断调整为高优先级
  76   1              ET1 = 0; 
  77   1      }
  78          
  79          void UART2Init()
  80          {
  81   1      #if(PARITYBIT2 == NONE_PARITY)
  82   1              S2CON = 0x50;                                   //8位可变波特率
  83   1      #elif(PARITYBIT2 == ODD_PARITY)||(PARITYBIT2 == EVEN_PARITY)||(PARITYBIT2 == MARK_PARITY)
                      S2CON = 0xda;                                   //9位可变波特率,校验位初始为1
              #elif(PARITYBIT2 == SPACE_PARITY)       
                      S2CON = 0xd2;                                   //9位可变波特率,校验位初始为0
              #endif
  88   1          T2L = (65536-(FOSC/4/BAUD));                //设置波特率重装值
  89   1              T2H = (65536-(FOSC/4/BAUD))>>8;
  90   1              AUXR |= 0x14;                                   //T2 1T模式,启动定时器2
  91   1              AUXR |= 0x01;                                   //定时器2为串口1的波特率发生器
  92   1              IE2 |= 0x01;                            //使能串口2中断
  93   1              //UART2Loc = 0;
  94   1              IP2 |= 0x01;                                                    //UART2中断调整为高优先级
  95   1              IP2 &= ~0xfe;
  96   1              //PS2 = 1;                                              
  97   1      }
  98          
  99          /*-------------------------
 100          UART1 中断服务程序
 101          -------------------------*/
 102          void Uart() interrupt 4
 103          {
 104   1              P15 = 1;
 105   1              if(RI)
 106   1              {
 107   2                      RI = 0;                     //清除RI位
 108   2                      UART1Temp = SBUF;
 109   2                      //UART1Temp[UART1Loc++] = SBUF;   
 110   2                      UART1RIREADY = 1;
 111   2                      if(WIFINEEDDELAY == 0)
 112   2                      {
 113   3                              EnableTimer4();
 114   3                              WIFINEEDDELAY = 1;
 115   3                      }
 116   2                      else
C51 COMPILER V9.00   UART                                                                  06/03/2016 18:24:02 PAGE 3   

 117   2                      {
 118   3                              T4times = 0;
 119   3                      }
 120   2              }
 121   1              if(TI)
 122   1              {
 123   2                      TI = 0;                     //清除TI位
 124   2                      busy = 0;                   //清忙标志
 125   2              }
 126   1      }
 127          
 128          /*--------------------------
 129          UART1发送数据
 130          --------------------------*/
 131          void SendData(BYTE dat)
 132          {
 133   1              while(busy);                     //等待前面的数据发送完成
 134   1              ACC = dat;                       //获取校验位P(PSW.0)
 135   1              if(P)
 136   1              {
 137   2              #if(PARITYBIT == ODD_PARITY)
                              TB8 = 0;                     //设置校验位为0
                      #elif(PARITYBIT == EVEN_PARITY)
                              TB8 = 1;                     //设置校验位为1
                      #endif
 142   2              }
 143   1              else
 144   1              {
 145   2              #if(PARITYBIT == ODD_PARITY)
                              TB8 = 1;                     //设置校验位为0
                      #elif(PARITYBIT == EVEN_PARITY)
                              TB8 = 0;                     //设置校验位为1
                      #endif
 150   2              }
 151   1              busy = 1;
 152   1              SBUF = ACC;                      //写数据到UART数据寄存器
 153   1              
 154   1      }
 155          
 156          /*--------------------------
 157          发送字符串
 158          --------------------------*/
 159          void SendString(char *s)
 160          {
 161   1          unsigned char FUCK = 0;
 162   1              while(*s)                        //检测字符串结束标志
 163   1              {
 164   2                      SendData(*s++);              //发送当前字符
 165   2                      FUCK ++;
 166   2                      if(FUCK==1)
 167   2                      {
 168   3                              P15 = 0;
 169   3                      }
 170   2              }
 171   1              
 172   1      }
 173          
 174          /*
 175           * 串口1发串口2接收的信息
 176           */
 177          void Uart1SendUart2String()
 178          {
C51 COMPILER V9.00   UART                                                                  06/03/2016 18:24:02 PAGE 4   

 179   1          //unsigned char i;
 180   1              //for(i=0;i<UART2Loc;i++)
 181   1              //{
 182   1              //      SendData(UART2Temp[i]);
 183   1              //}
 184   1              //UART2Loc = 0;
 185   1              SendData(UART2Temp);
 186   1      }
 187          
 188          /*-------------------------
 189          UART2 中断服务程序
 190          -------------------------*/
 191          void Uart2() interrupt 8
 192          {
 193   1              if(S2CON&S2RI)
 194   1              {
 195   2                      S2CON&=~S2RI;                   //清除RI位
 196   2                      //UART2Temp[UART2Loc++] = S2BUF;   
 197   2                      //UART2RIREADY = 1;
 198   2                      UART2Temp = S2BUF;
 199   2                      if(WIFINEEDDELAY == 0)
 200   2                      {
 201   3                              EnableTimer4();
 202   3                              WIFINEEDDELAY = 1;
 203   3                      }
 204   2                      else
 205   2                      {
 206   3                              T4times = 0;
 207   3                      }
 208   2                      //SendData(SBUF);
 209   2                      //P22 = RB8;                    //P2.2显示检验位
 210   2              }
 211   1              if(S2CON&S2TI)
 212   1              {
 213   2                      S2CON&=~S2TI;                   //清除TI位
 214   2                      busy2 = 0;                              //清忙标志
 215   2              }
 216   1      }
 217          
 218          /*--------------------------
 219          UART2发送数据
 220          --------------------------*/
 221          void SendData2(BYTE dat)
 222          {
 223   1              while(busy2);                           //等待前面的数据发送完成
 224   1              ACC = dat;                              //获取校验位P(PSW.0)
 225   1              if(P)
 226   1              {
 227   2              #if(PARITYBIT2 == ODD_PARITY)
                              S2CON&=~S2TB8;                  //设置校验位为0
                      #elif(PARITYBIT2 == EVEN_PARITY)
                              S2CON|=~S2TB8;                  //设置校验位为1
                      #endif
 232   2              }
 233   1              else
 234   1              {
 235   2              #if(PARITYBIT2 == ODD_PARITY)
                              S2CON|=~S2TB8;                  //设置校验位为1
                      #elif(PARITYBIT2 == EVEN_PARITY)
                              S2CON&=~S2TB8;                  //设置校验位为0
                      #endif
 240   2              }
C51 COMPILER V9.00   UART                                                                  06/03/2016 18:24:02 PAGE 5   

 241   1              busy2 = 1;
 242   1              S2BUF = ACC;                            //写数据到UART数据寄存器
 243   1              
 244   1      }
 245          
 246          /*--------------------------
 247          UART2发送字符串
 248          --------------------------*/
 249          void SendString2(char *s)
 250          {
 251   1              while(*s)                               //检测字符串结束标志
 252   1              {
 253   2                      SendData2(*s++);                //发送当前字符
 254   2              }
 255   1      }
 256          
 257          void SendString2Length(char s[], unsigned char length)
 258          {
 259   1              unsigned char i;
 260   1              for(i=0;i<length;i++)
 261   1              {
 262   2                      SendData2(s[i]);                //发送当前字符
 263   2              }
 264   1              //WIFINEEDDELAY = 0;
 265   1      }
 266          
 267          /*
 268           * 串口2发串口1接收的信息
 269           */
 270          void Uart2SendUart1String()
 271          {
 272   1          //unsigned char i;
 273   1              //for(i=0;i<UART1Loc;i++)
 274   1              //{
 275   1              SendData2(UART1Temp);
 276   1              //}
 277   1              //UART1Loc = 0;
 278   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    450    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      2       9
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      2    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
