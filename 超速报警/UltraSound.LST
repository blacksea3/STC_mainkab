C51 COMPILER V9.00   ULTRASOUND                                                            05/26/2016 23:42:01 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE ULTRASOUND
OBJECT MODULE PLACED IN UltraSound.OBJ
COMPILER INVOKED BY: E:\software\DevelopmentSoftware\InstallSrc\KeilC51\C51\BIN\C51.EXE UltraSound.c COMPACT BROWSE DEBU
                    -G OBJECTEXTEND

line level    source

   1          #include "stc15.h"
   2          //#include "UART.h"
   3          #include "Timer.h"
   4          #include "Delay.h"
   5          #include "LCD12864.h"
   6          #include "main.h"
   7          #include "FLASH.h"
   8          
   9          sbit trig=P1^0; //触发输入 至少为10us以上
  10          sbit echo=P1^1; //输出回响信号
  11          
  12          unsigned long RawTime;
  13          signed int RealDistance;
  14          
  15          #define FOSC_FENZHIYI 9.0422e-5                 //先乘1000,下面直接当成毫秒
  16          
  17          char bat[7]; //保存超声波测量的数据，单位为m    //1个操作9.0422e-8   1000个e-5    RawTime*FOSC_FENZHIYI s
  18          void delay(unsigned int i)
  19          {
  20   1              while(i--);
  21   1      }
  22          
  23          void UltraSoundInit()
  24          {
  25   1              Timer1Init();
  26   1      }
  27          
  28          void super_start()      //触发超声波开始工作
  29          {
  30   1              trig=1;
  31   1              delay(10);       //至少10us
  32   1              trig=0; 
  33   1      }
  34          signed int super_count()          //计算超声波回响的高电平持续时间,直接取出TH1和额TL1            0-25m/s
  35          {
  36   1          RawTime=65536*T1times+TH1*256+TL1;
  37   1              RealDistance=(RawTime*FOSC_FENZHIYI*170);   //精确到mm                                                           3m         1/11059200 s  假设1m 则t=2m/340
             -m/s  
  38   1                                                                                                                                                                       //0-4000          pp *          9.0422e-8 s * 170m/s = 4000mm
  39   1              //bat[0]=RealDistance/1000 + 48;
  40   1              //bat[1]=(unsigned char)('.');
  41   1              //bat[2]=RealDistance%1000/100 + 48;
  42   1              //bat[3]=RealDistance%100/10 + 48;
  43   1              //bat[4]=RealDistance%10 + 48;
  44   1              //bat[5]=(unsigned char)('m');
  45   1              //bat[6]=(unsigned char)('m');
  46   1              //bat[7]='\0';
  47   1              return RealDistance;
  48   1      }
  49          
  50          signed int DisUltraSound()
  51          {
  52   1          signed int t;
  53   1              super_start();
C51 COMPILER V9.00   ULTRASOUND                                                            05/26/2016 23:42:01 PAGE 2   

  54   1              while(echo==0);   //等待高电平
  55   1              EnableTimer1();   //打开定时器1开始计时
  56   1              while(echo==1);   //等待高电平下去变成低电平（高电平持续）
  57   1              DisableTimer1();  //关闭定时器1
  58   1              t=super_count();
  59   1              return t;
  60   1      }
  61          
  62          void UltraSoundDisplay()
  63          {     
  64   1          //unsigned char bat1[8]={0,0,0,0,0,0};
  65   1              //unsigned char bat2[8]={0,0,0,0,0,0};
  66   1              //unsigned char bat3[10]={'+',0,'.',0,0,0,'m','/','s','\0'};
  67   1                
  68   1              unsigned char VelocityData[] = {"速度为000000000 "};                    //字符串初始化
  69   1              unsigned long Dis1,Dis2,DDis;                                                           //临时变量
  70   1              unsigned char i;                                                                                        //临时变量
  71   1      
  72   1              unsigned int TempVelocityThreshold;                                             //速度阈值
  73   1      
  74   1          TempVelocityThreshold = GetVelocityThreshold();                             //获取当前速度阈值
  75   1      
  76   1              //for(i=0;i<5;i++)
  77   1          //{
  78   1              //      Delay10ms();
  79   1              //}
  80   1          Dis1=DisUltraSound();                                                                       //超声波模块测距
  81   1          for(i=0;i<5;i++)
  82   1              {
  83   2                      Delay50ms();
  84   2              }
  85   1          Dis2=DisUltraSound();                                                                       //超声波模块测距
  86   1      
  87   1          if(Dis1>4000 || Dis2>4000)                                                                  //单位mm
  88   1              {
  89   2                      VelocityData[7] = 'N';
  90   2                      VelocityData[8] = '/';
  91   2                      VelocityData[9] = 'A';
  92   2                      VelocityData[10] = 'N';
  93   2                      VelocityData[11] = '/';
  94   2                      VelocityData[12] = 'A';
  95   2                      VelocityData[13] = 'N';
  96   2                      VelocityData[14] = 'A';
  97   2                      VelocityData[15]='\0';
  98   2      
  99   2                      Display_String(1,VelocityData);
 100   2              }
 101   1              else
 102   1              {
 103   2              if(Dis1>Dis2)
 104   2                      {
 105   3                              DDis=Dis1-Dis2;
 106   3                              VelocityData[6] = '+';
 107   3                      }
 108   2                      else
 109   2                      {
 110   3                              DDis=Dis2-Dis1;
 111   3                              VelocityData[6] = '-';
 112   3                      }
 113   2                      DDis*=4;                                                                                        //单位mm  时间差是250ms,要乘1000ms/250ms=4
 114   2              DDis*=3.6;                                                                                      //转为km/h,取整即可
 115   2                      VelocityData[7]=DDis%100000/10000 + 48;
C51 COMPILER V9.00   ULTRASOUND                                                            05/26/2016 23:42:01 PAGE 3   

 116   2                      VelocityData[8]=DDis%10000/1000 + 48;
 117   2                      VelocityData[9]=(unsigned char)('.');
 118   2                      VelocityData[10]=DDis%1000/100 + 48;                                            
 119   2                      VelocityData[11]=DDis%100/10 + 48;
 120   2                      //VelocityData[10]=DDis%10 + 48;
 121   2                      VelocityData[12]=(unsigned char)('k');                                                   
 122   2                      VelocityData[13]=(unsigned char)('m');
 123   2                      VelocityData[14]=(unsigned char)('/');
 124   2                      VelocityData[15]=(unsigned char)('h');
 125   2                      VelocityData[16]='\0';
 126   2      
 127   2                      Display_String(1,VelocityData);
 128   2      
 129   2                      if((unsigned int)DDis > TempVelocityThreshold)                                   //超过速度阈值,单位m/h,1000mm/s=1m/s=3.6km/h
 130   2                      {        
 131   3                              FASTSPEED = 1;
 132   3                              P20 = !P20;
 133   3                              //Display_String(1,VelocityData);
 134   3                              //LCD12864DisplayChar(2,6,DDis%100000/10000 + 48);
 135   3                              //LCD12864DisplayChar(2,7,DDis%10000/1000 + 48);
 136   3                              //LCD12864DisplayChar(2,8,DDis%1000/100 + 48);
 137   3                              //LCD12864DisplayChar(3,7,TempVelocityThreshold%1000/100 + 48);                                      
 138   3                      }
 139   2              }       
 140   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    787    ----
   CONSTANT SIZE    =     17    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     13      32
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
