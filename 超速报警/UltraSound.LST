C51 COMPILER V9.00   ULTRASOUND                                                            05/22/2016 00:43:47 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE ULTRASOUND
OBJECT MODULE PLACED IN UltraSound.OBJ
COMPILER INVOKED BY: E:\software\DevelopmentSoftware\InstallSrc\KeilC51\C51\BIN\C51.EXE UltraSound.c COMPACT BROWSE DEBU
                    -G OBJECTEXTEND

line level    source

   1          #include "stc15.h"
   2          #include "UART.h"
   3          #include "Timer.h"
   4          #include "Delay.h"
   5          #include "LCD12864.h"
   6          
   7          sbit trig=P1^0; //触发输入 至少为10us以上
   8          sbit echo=P1^1; //输出回响信号
   9          
  10          unsigned long RawTime;
  11          signed int RealDistance;
  12          
  13          #define FOSC_FENZHIYI 9.0422e-5                 //先乘1000,下面直接当成毫秒
  14          
  15          char bat[7]; //保存超声波测量的数据，单位为m    //1个操作9.0422e-8   1000个e-5    RawTime*FOSC_FENZHIYI s
  16          void delay(unsigned int i)
  17          {
  18   1              while(i--);
  19   1      }
  20          
  21          void UltraSoundInit()
  22          {
  23   1              Timer1Init();
  24   1      }
  25          
  26          void super_start()      //触发超声波开始工作
  27          {
  28   1              trig=1;
  29   1              delay(10);       //至少10us
  30   1              trig=0; 
  31   1      }
  32          signed int super_count()          //计算超声波回响的高电平持续时间,直接取出TH1和额TL1            0-25m/s
  33          {
  34   1          RawTime=65536*T1times+TH1*256+TL1;
  35   1              RealDistance=(RawTime*FOSC_FENZHIYI*170);   //精确到mm                                                           3m         1/11059200 s  假设1m 则t=2m/340
             -m/s  
  36   1                                                                                                                                                                       //0-4000          pp *          9.0422e-8 s * 170m/s = 4000mm
  37   1              //bat[0]=RealDistance/1000 + 48;
  38   1              //bat[1]=(unsigned char)('.');
  39   1              //bat[2]=RealDistance%1000/100 + 48;
  40   1              //bat[3]=RealDistance%100/10 + 48;
  41   1              //bat[4]=RealDistance%10 + 48;
  42   1              //bat[5]=(unsigned char)('m');
  43   1              //bat[6]=(unsigned char)('m');
  44   1              //bat[7]='\0';
  45   1              return RealDistance;
  46   1      }
  47          
  48          signed int DisUltraSound()
  49          {
  50   1          signed int t;
  51   1              super_start();
  52   1              while(echo==0);   //等待高电平
  53   1              EnableTimer1();   //打开定时器1开始计时
C51 COMPILER V9.00   ULTRASOUND                                                            05/22/2016 00:43:47 PAGE 2   

  54   1              while(echo==1);   //等待高电平下去变成低电平（高电平持续）
  55   1              DisableTimer1();  //关闭定时器1
  56   1              t=super_count();
  57   1              return t;
  58   1      }
  59          
  60          void UltraSoundDisplay()
  61          {     
  62   1          //unsigned char bat1[8]={0,0,0,0,0,0};
  63   1              //unsigned char bat2[8]={0,0,0,0,0,0};
  64   1              //unsigned char bat3[10]={'+',0,'.',0,0,0,'m','/','s','\0'};
  65   1                
  66   1              unsigned char VelocityData[] = {"速度为000000000"};
  67   1              unsigned long Dis1,Dis2,DDis;
  68   1              unsigned char i;
  69   1      
  70   1              //for(i=0;i<5;i++)
  71   1          //{
  72   1              //      Delay10ms();
  73   1              //}
  74   1          Dis1=DisUltraSound();                 //超声波模块测距
  75   1          for(i=0;i<5;i++)
  76   1              {
  77   2                      Delay50ms();
  78   2              }
  79   1          Dis2=DisUltraSound();                 //超声波模块测距
  80   1      
  81   1          if(Dis1>4000 || Dis2>4000)                                                            //单位mm
  82   1              {
  83   2                      VelocityData[7] = 'N';
  84   2                      VelocityData[8] = '/';
  85   2                      VelocityData[9] = 'A';
  86   2                      VelocityData[10] = 'N';
  87   2                      VelocityData[11] = '/';
  88   2                      VelocityData[12] = 'A';
  89   2                      VelocityData[13] = 'N';
  90   2                      VelocityData[14] = 'A';
  91   2                      VelocityData[15]='\0';
  92   2      
  93   2                      Display_String(1,VelocityData);
  94   2              }
  95   1              else
  96   1              {
  97   2              //bat1[0]=Dis1/10000 + 48;
  98   2              //bat1[1]=Dis1%10000/1000 + 48;
  99   2              /*bat1[0]=Dis1%10000/1000 + 48;
 100   2              bat1[1]=(unsigned char)('.');                                                           
 101   2              bat1[2]=Dis1%1000/100 + 48;
 102   2              bat1[3]=Dis1%100/10 + 48;
 103   2              bat1[4]=Dis1%10 + 48;
 104   2              bat1[5]=(unsigned char)('m');
 105   2              bat1[6]='\0';
 106   2          Display_String(2,bat1);
 107   2      
 108   2          Delay1ms();
 109   2                                                                                                                                               
 110   2              bat2[0]=Dis2%10000/1000 + 48;
 111   2              bat2[1]=(unsigned char)('.');                                                           
 112   2              bat2[2]=Dis2%1000/100 + 48;
 113   2              bat2[3]=Dis2%100/10 + 48;
 114   2              bat2[4]=Dis2%10 + 48;
 115   2              bat2[5]=(unsigned char)('m');
C51 COMPILER V9.00   ULTRASOUND                                                            05/22/2016 00:43:47 PAGE 3   

 116   2              bat2[6]='\0';
 117   2              Display_String(3,bat2);
 118   2      
 119   2          Delay1ms();*/
 120   2      
 121   2          if(Dis1>Dis2)
 122   2              {
 123   3                      DDis=Dis1-Dis2;
 124   3                      VelocityData[6] = '+';
 125   3              }
 126   2              else
 127   2              {
 128   3                      DDis=Dis2-Dis1;
 129   3                      VelocityData[6] = '-';
 130   3              }
 131   2                                                                                                                         //单位mm  时间 50ms      4000mm/50ms  ->  4000*20=80m/s
 132   2              DDis*=4;
 133   2              
 134   2              VelocityData[7]=DDis%10000/1000 + 48;
 135   2              VelocityData[8]=(unsigned char)('.');                                                   
 136   2              VelocityData[9]=DDis%1000/100 + 48;
 137   2              VelocityData[10]=DDis%100/10 + 48;
 138   2              VelocityData[11]=DDis%10 + 48;
 139   2              VelocityData[12]=(unsigned char)('m');
 140   2              VelocityData[13]=(unsigned char)('/');
 141   2              VelocityData[14]=(unsigned char)('s');
 142   2              VelocityData[15]='\0';
 143   2      
 144   2              Display_String(1,VelocityData);
 145   2              }       
 146   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    680    ----
   CONSTANT SIZE    =     16    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     13      29
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
